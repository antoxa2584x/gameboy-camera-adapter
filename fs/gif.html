<!DOCTYPE html>
<html lang="en">
  <head>
    <title>GameBoy Camera Adapter</title>
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="apple-mobile-web-app-title" content="GameBoy Camera Adapter">
    <link rel="manifest" href="site.webmanifest">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#cc3366">
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="application-name" content="GameBoy Camera Adapter">
    <meta name="msapplication-TileColor" content="#ece6e6">
    <meta name="theme-color" content="#ece6e6">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="GameBoy Camera Adapter">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <script src="/gif.js"></script>
    <script defer src="/script.js?1"></script>
    <script src="/NoSleep.min.js"></script>
  </head>
  <body>
    <div style="color: white; position: absolute; left: 0; top: 0; margin-top: 130px; text-align: center; right: 0;">
      <button onclick="window.location.href='/';">PHOTO Mode</button>
      <button onclick="window.location.href='/gif.html';" style="text-decoration: underline;">GIF Mode</button>
    </div>
    <div id="content" class="container">
      <div id="header">
        <img src="logo.webp" alt="logo" style="padding:10%;width:80%;flex:auto;">
        <button style="display:none" id="get_image_btn">Get Images</button>
        <button style="display:none" id="tear_btn">Tear</button>
        <button style="display:none" id="select_all_btn" disabled>Select All</button>
        <button style="display:none" id="delete_selected_btn" disabled>Delete</button>
        <button style="display:none" id="average_selected_btn" disabled>Average</button>
        <div id="color-selector">
          <div class="color-circle active" style="background:linear-gradient(to right, #ffffff 25%, #bfbfbf 25% 50%, #7f7f7f 50% 75%, #3f3f3f 75%)" data-scheme="grayscale"></div>
          <div class="color-circle" style="background:linear-gradient(to right, #d0d93c 25%, #78a46a 25% 50%, #545854 50% 75%, #244624 75%)" data-scheme="game-boy"></div>
          <div class="color-circle" style="background:linear-gradient(to right, #ffffff 25%, #b5b3bd 25% 50%, #545367 50% 75%, #090713 75%)" data-scheme="super-game-boy"></div>
          <div class="color-circle" style="background:linear-gradient(to right, #f0f0f0 25%, #dac46a 25% 50%, #705834 50% 75%, #1e1e1e 75%)" data-scheme="game-boy-color-jpn"></div>
          <div class="color-circle" style="background:linear-gradient(to right, #f0f0f0 25%, #dca0a0 25% 50%, #884e4e 50% 75%, #1e1e1e 75%)" data-scheme="game-boy-color-usa-gold"></div>
          <div class="color-circle" style="background:linear-gradient(to right, #f0f0f0 25%, #86c864 25% 50%, #3a6084 50% 75%, #1e1e1e 75%)" data-scheme="game-boy-color-usa-eur"></div>
        </div>
        <br>
      </div>
      <div>
        <label for="scaleSelector">Scale:</label>
        <select id="scaleSelector">
          <option value="1">1x</option>
          <option value="2">2x</option>
          <option value="4" selected>4x</option>
          <option value="8">8x</option>
        </select>
      </div>
      <div id="gallery"></div>
    </div>
    <p id="description">
      GIF MODE
      <br>
      <input type="button" id="toggle" value="Wake Lock is disabled" style="font-family: 'Press Start 2P', cursive; border: 1px solid white; padding: 5px;" />
    </p>

    <footer>
      <div class="links">
        <a href="https://github.com/untoxa/pico-gb-printer" target="_blank" id="image-link" aria-label="untoxa/pico-gb-printer">
          <img src="github.png" alt="GitHub Project">
        </a>
        <a href="https://www.instagram.com/retrogaming_ua/" target="_blank" id="image-link" aria-label="Instagram">
          <img src="instagram.png" alt="Instagram">
        </a>
      </div>
    </footer>

    <script>
      var noSleep = new NoSleep();

      var wakeLockEnabled = false;
      var toggleEl = document.querySelector("#toggle");
      toggleEl.addEventListener('click', function() {
        if (!wakeLockEnabled) {
          noSleep.enable(); // keep the screen on!
          wakeLockEnabled = true;
          toggleEl.value = "Wake Lock is enabled";
          document.body.style.backgroundColor = "green";
        } else {
          noSleep.disable(); // let the screen turn off.
          wakeLockEnabled = false;
          toggleEl.value = "Wake Lock is disabled";
          document.body.style.backgroundColor = "";
        }
      }, false);

      window.gifMode = true;

      let gif = null;

      let previewCanvas = null;
      let previewCtx = null;
      let frameCount = 0;

      function initGif(width, height) {
        document.getElementById('scaleSelector').disabled = true;

        gif = new GIF({
          workers: 2,
          quality: 10,
          width: width,
          height: height,
          workerScript: '/gif.worker.js',
        });

        const gallery = document.getElementById('gallery');
        gallery.innerHTML = ''; // Clear previous

        gallery.innerHTML = '<div class="gallery-image"></div>';

        previewCanvas = document.createElement('canvas');
        previewCanvas.width = width;
        previewCanvas.height = height;
        // previewCanvas.style.border = "1px solid black";
        gallery.getElementsByClassName('gallery-image')[0].insertAdjacentHTML('beforeend', '<br>');
        gallery.getElementsByClassName('gallery-image')[0].appendChild(previewCanvas);
        gallery.getElementsByClassName('gallery-image')[0].insertAdjacentHTML('beforeend', '<button class="shake" onclick="downloadGif()">SAVE</button>');
        gallery.getElementsByClassName('gallery-image')[0].insertAdjacentHTML('beforeend', '<br><button class="shake" onclick="resetGif()">RESET GIF</button>');
        
        previewCtx = previewCanvas.getContext('2d');
      }

      function addCanvasToGif2(canvas, delay = 200) {
        if (!gif) initGif(canvas.width, canvas.height);
        gif.addFrame(canvas, { delay: delay, copy: true });

        if (previewCtx) {
          previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
          previewCtx.drawImage(canvas, 0, 0);
        }
      }

      function addCanvasToGif(canvas, delay = 200) {
        const scale = parseInt(document.getElementById('scaleSelector').value);

        const scaledCanvas = document.createElement('canvas');
        scaledCanvas.width = canvas.width * scale;
        scaledCanvas.height = canvas.height * scale;

        const ctx = scaledCanvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        ctx.webkitImageSmoothingEnabled = false;
        ctx.mozImageSmoothingEnabled = false;
        ctx.msImageSmoothingEnabled = false;

        ctx.drawImage(canvas, 0, 0, scaledCanvas.width, scaledCanvas.height);

        if (!gif) initGif(scaledCanvas.width, scaledCanvas.height);
        gif.addFrame(scaledCanvas, { delay: delay, copy: true });

        if (previewCtx) {
          previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
          previewCtx.drawImage(scaledCanvas, 0, 0);
        }
      }

      function resetGif() {
        gif = null;
        // initGif();

        const gallery = document.getElementById('gallery');
        gallery.innerHTML = ''; // Clear previous
        document.getElementById('scaleSelector').disabled = false;
      }

      function downloadGif(filename = "animation.gif") {
        if (!gif) return;
        gif.on('finished', function(blob) {
          console.log('GIF created:', blob);
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);
        });
        gif.render();
      }

      // Example: match your interface
      // function addCanvasToGallery(canvas) {
      //   addCanvasToGif(canvas);
      // }

    </script>

    <style>
      .gallery-image canvas{
        max-width: 100%;
        image-rendering: pixelated;
      }
    </style>
  </body>
</html>